<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Eugene Khvedchenya
|
A very fast BGRA to Grayscale conversion on Iphone</title><meta charset=utf-8><meta name=generator content="Hugo 0.98.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Eugene Khvedchenya"><meta name=description content="A personal blog about Computer Vision, AI, Kaggle, Open-Source and research. You will never read this in books."><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://computer-vision-talks.com/post/2011-02-08-a-very-fast-bgra-to-grayscale-conversion-on-iphone/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.560a26330d27ff44a44e83b53cd07a95d4230a65930d31c5c76a8d481e5b35bf.js integrity="sha256-VgomMw0n/0SkToO1PNB6ldQjCmWTDTHFx2qNSB5bNb8=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="A very fast BGRA to Grayscale conversion on Iphone"><meta name=twitter:description content="Almost all image processing algorithms uses gray scale images as input source. But almost all hardware video sources provide frames in RGB/BGR(A) formats. So gray scale conversion is very popular operation. Although it&rsquo;s expensive enough to cause CPU-bound bottlenecks while running on mobile processors. In this post i will show you how to use ARM NEON intrinsic to get significant performance boost of BGRA to GRAY conversion.
Color representation Pixel color can be presented in different ways."><meta property="og:title" content="A very fast BGRA to Grayscale conversion on Iphone"><meta property="og:description" content="Almost all image processing algorithms uses gray scale images as input source. But almost all hardware video sources provide frames in RGB/BGR(A) formats. So gray scale conversion is very popular operation. Although it&rsquo;s expensive enough to cause CPU-bound bottlenecks while running on mobile processors. In this post i will show you how to use ARM NEON intrinsic to get significant performance boost of BGRA to GRAY conversion.
Color representation Pixel color can be presented in different ways."><meta property="og:type" content="article"><meta property="og:url" content="https://computer-vision-talks.com/post/2011-02-08-a-very-fast-bgra-to-grayscale-conversion-on-iphone/"><meta property="article:section" content="post"><meta property="article:published_time" content="2011-02-08T00:00:00+00:00"><meta property="article:modified_time" content="2011-02-08T00:00:00+00:00"><meta property="og:site_name" content="Computer Vision Talks"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"A very fast BGRA to Grayscale conversion on Iphone","headline":"A very fast BGRA to Grayscale conversion on Iphone","alternativeHeadline":"","description":"
      
        Almost all image processing algorithms uses gray scale images as input source. But almost all hardware video sources provide frames in RGB\/BGR(A) formats. So gray scale conversion is very popular operation. Although it\u0026rsquo;s expensive enough to cause CPU-bound bottlenecks while running on mobile processors. In this post i will show you how to use ARM NEON intrinsic to get significant performance boost of BGRA to GRAY conversion.\nColor representation Pixel color can be presented in different ways.


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/computer-vision-talks.com\/post\/2011-02-08-a-very-fast-bgra-to-grayscale-conversion-on-iphone\/"},"author":{"@type":"Person","name":"Eugene Khvedchenya"},"creator":{"@type":"Person","name":"Eugene Khvedchenya"},"accountablePerson":{"@type":"Person","name":"Eugene Khvedchenya"},"copyrightHolder":{"@type":"Person","name":"Eugene Khvedchenya"},"copyrightYear":"2011","dateCreated":"2011-02-08T00:00:00.00Z","datePublished":"2011-02-08T00:00:00.00Z","dateModified":"2011-02-08T00:00:00.00Z","publisher":{"@type":"Organization","name":"Eugene Khvedchenya","url":"https://computer-vision-talks.com/","logo":{"@type":"ImageObject","url":"https:\/\/computer-vision-talks.com\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/computer-vision-talks.com\/post\/2011-02-08-a-very-fast-bgra-to-grayscale-conversion-on-iphone\/","wordCount":"764","genre":[],"keywords":["xcode","neon"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/4ECfkGJr_400x400.jpg alt="profile picture"><div class=sidebar__introduction-title><a href=/>Computer Vision Talks</a></div><div class=sidebar__introduction-description><p>A personal blog about Computer Vision, AI, Kaggle, Open-Source and research. You will never read this in books.</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/cvtalks/ target=_blank rel=noopener aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/cvtalks target=_blank rel=noopener aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/BloodAxe target=_blank rel=noopener aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:ekhvedchenya@computer-vision-talks.com target=_blank rel=noopener aria-label=E-Mail title=E-Mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Eugene Khvedchenya
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-10687369-5","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/post/ title>Posts</a></li><li class=nav__list-item><a href=/open-source title>Open-Source</a></li><li class=nav__list-item><a href=/challenges title>Wins</a></li><li class=nav__list-item><a href=/publications title>Publications</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>A Very Fast BGRA to Grayscale Conversion on Iphone</h1><ul class=post__meta><li class=post__meta-item><em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>Tue, Feb 8, 2011</span></li><li class=post__meta-item><em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>4-minute read</span></li></ul><p><img src=NEON_ProductImage.jpg alt title=NEON></p><p>Almost all image processing algorithms uses gray scale images as input source. But almost all hardware video sources provide frames in RGB/BGR(A) formats. So gray scale conversion is very popular operation. Although it&rsquo;s expensive enough to cause CPU-bound bottlenecks while running on mobile processors. In this post i will show you how to use ARM NEON intrinsic to get significant performance boost of BGRA to GRAY conversion.</p><p></p><h2 id=color-representation>Color representation</h2><p><img src=RGB_illumination.jpg alt></p><p>Pixel color can be presented in different ways. RGB color model presents color as a combination of three base colors of different intensity. Gray scale image contains only pixel luminance value without specific color. Pixels from RGB color model can be converted to gray scale using following formula: Y = 0.2126 R + 0.7152 G + 0.0722 B. Multipliers can very depending on the color space standards. Since we are targeting to iPhone it’s necessary to remember that camera capture from iOS AVFramework provide video frames in BGRA format (alpha channel is always equals to 255). For our further steps we will ignore it.</p><h2 id=implementation>Implementation:</h2><p>First of all we need reference C++ implementation. Just to know the starting point. Here it is:</p><h4 id=reference-c-bgra-to-grayscale-conversion-function>Reference C++ BGRA to Grayscale conversion function:</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>reference_convert</span> <span class=p>(</span><span class=n>common</span><span class=o>::</span><span class=n>UInt8</span> <span class=o>*</span> <span class=n>dest</span><span class=p>,</span> <span class=n>common</span><span class=o>::</span><span class=n>UInt8</span> <span class=o>*</span> <span class=n>src</span><span class=p>,</span> <span class=kt>int</span> <span class=n>n</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>r</span><span class=p>,</span><span class=n>g</span><span class=p>,</span><span class=n>b</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>y</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=n>i</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>b</span> <span class=o>=</span> <span class=o>*</span><span class=n>src</span><span class=o>++</span><span class=p>;</span> <span class=c1>// load blue
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>g</span> <span class=o>=</span> <span class=o>*</span><span class=n>src</span><span class=o>++</span><span class=p>;</span> <span class=c1>// load green
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>r</span> <span class=o>=</span> <span class=o>*</span><span class=n>src</span><span class=o>++</span><span class=p>;</span> <span class=c1>// load red
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>src</span><span class=o>++</span><span class=p>;</span> <span class=c1>// skip aplha
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=c1>// build weighted average:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=n>y</span> <span class=o>=</span> <span class=p>(</span><span class=n>r</span><span class=o>*</span><span class=mi>77</span><span class=p>)</span><span class=o>+</span><span class=p>(</span><span class=n>g</span><span class=o>*</span><span class=mi>151</span><span class=p>)</span><span class=o>+</span><span class=p>(</span><span class=n>b</span><span class=o>*</span><span class=mi>28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=c1>// undo the scale by 256 and write to memory:
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=o>*</span><span class=n>dest</span><span class=o>++</span> <span class=o>=</span> <span class=p>(</span><span class=n>y</span><span class=o>&gt;&gt;</span><span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Okay, this function works relatively fast but not enough. Since iPhone has ARM CPU (Cortex A-9), it supports SIMD NEON engine which can be used for color conversion with great effort. SIMD technology allows process multiple data with one instruction call, saving time for other computations. Cutting a long story shorter – we will process eighth(!) pixels at one time.</p><p><img src=NEON_ISA.jpg alt></p><p>Fortunately, you don’t have to deal with such low-level instructions directly. There are special functions, called intrinsic, which can be treated as regular functions but they works with input data simultaneously. If you want to learn more about NEON intrinsic you will found link in the “References” section.</p><h4 id=arm-neon-intrinsic-optimized-conversion>ARM NEON Intrinsic-optimized conversion:</h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=kt>void</span> <span class=nf>neon_convert</span> <span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span> <span class=n>__restrict</span> <span class=n>dest</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span> <span class=n>__restrict</span> <span class=n>src</span><span class=p>,</span> <span class=kt>int</span> <span class=n>numPixels</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>i</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=n>uint8x8_t</span> <span class=n>rfac</span> <span class=o>=</span> <span class=n>vdup_n_u8</span> <span class=p>(</span><span class=mi>77</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>uint8x8_t</span> <span class=n>gfac</span> <span class=o>=</span> <span class=n>vdup_n_u8</span> <span class=p>(</span><span class=mi>151</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=n>uint8x8_t</span> <span class=n>bfac</span> <span class=o>=</span> <span class=n>vdup_n_u8</span> <span class=p>(</span><span class=mi>28</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=kt>int</span> <span class=n>n</span> <span class=o>=</span> <span class=n>numPixels</span> <span class=o>/</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>  <span class=c1>// Convert per eight pixels
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>for</span> <span class=p>(</span><span class=n>i</span><span class=o>=</span><span class=mi>0</span><span class=p>;</span> <span class=n>i</span> <span class=o>&lt;</span> <span class=n>n</span><span class=p>;</span> <span class=o>++</span><span class=n>i</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>uint16x8_t</span>  <span class=n>temp</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>uint8x8x4_t</span> <span class=n>rgb</span>  <span class=o>=</span> <span class=n>vld4_u8</span> <span class=p>(</span><span class=n>src</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>uint8x8_t</span> <span class=n>result</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>temp</span> <span class=o>=</span> <span class=n>vmull_u8</span> <span class=p>(</span><span class=n>rgb</span><span class=p>.</span><span class=n>val</span><span class=p>[</span><span class=mi>0</span><span class=p>],</span>      <span class=n>bfac</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>temp</span> <span class=o>=</span> <span class=n>vmlal_u8</span> <span class=p>(</span><span class=n>temp</span><span class=p>,</span><span class=n>rgb</span><span class=p>.</span><span class=n>val</span><span class=p>[</span><span class=mi>1</span><span class=p>],</span> <span class=n>gfac</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>temp</span> <span class=o>=</span> <span class=n>vmlal_u8</span> <span class=p>(</span><span class=n>temp</span><span class=p>,</span><span class=n>rgb</span><span class=p>.</span><span class=n>val</span><span class=p>[</span><span class=mi>2</span><span class=p>],</span> <span class=n>rfac</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=n>result</span> <span class=o>=</span> <span class=n>vshrn_n_u16</span> <span class=p>(</span><span class=n>temp</span><span class=p>,</span> <span class=mi>8</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>vst1_u8</span> <span class=p>(</span><span class=n>dest</span><span class=p>,</span> <span class=n>result</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=n>src</span>  <span class=o>+=</span> <span class=mi>8</span><span class=o>*</span><span class=mi>4</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=n>dest</span> <span class=o>+=</span> <span class=mi>8</span><span class=p>;</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>This function process eight pixels per iteration. Great performance boost but I decided to go further and rewrite anything using assembler. This requires much more knowledge about CPU Architecture but result was worth of it.</p><h2 id=neon-and-assembler>NEON and Assembler:</h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>static</span> <span class=kt>void</span> <span class=nf>neon_asm_convert</span><span class=p>(</span><span class=kt>uint8_t</span> <span class=o>*</span> <span class=n>__restrict</span> <span class=n>dest</span><span class=p>,</span> <span class=kt>uint8_t</span> <span class=o>*</span> <span class=n>__restrict</span> <span class=n>src</span><span class=p>,</span> <span class=kt>int</span> <span class=n>numPixels</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=k>asm</span> <span class=k>volatile</span><span class=p>(</span><span class=s>&#34;lsr          %2, %2, #3      </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;# build the three constants: </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;mov         r4, #28          </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Blue channel multiplier
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=s>&#34;mov         r5, #151         </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Green channel multiplier
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=s>&#34;mov         r6, #77          </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Red channel multiplier
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=s>&#34;vdup.8      d4, r4           </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vdup.8      d5, r5           </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vdup.8      d6, r6           </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;.loop:                       </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;# load 8 pixels:             </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vld4.8      {d0-d3}, [%1]!   </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;# do the weight average:     </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vmull.u8    q7, d0, d4       </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vmlal.u8    q7, d1, d5       </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vmlal.u8    q7, d2, d6       </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;# shift and store:           </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;vshrn.u16   d7, q7, #8       </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Divide q3 by 256 and store in the d7
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=s>&#34;vst1.8      {d7}, [%0]!      </span><span class=se>\n</span><span class=s>&#34;</span>
</span></span><span class=line><span class=cl>               <span class=s>&#34;subs        %2, %2, #1       </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Decrement iteration count
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=s>&#34;bne         .loop            </span><span class=se>\n</span><span class=s>&#34;</span> <span class=c1>// Repeat unil iteration count is not zero
</span></span></span><span class=line><span class=cl><span class=c1></span>               <span class=o>:</span>
</span></span><span class=line><span class=cl>               <span class=o>:</span> <span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>dest</span><span class=p>),</span> <span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>src</span><span class=p>),</span> <span class=s>&#34;r&#34;</span><span class=p>(</span><span class=n>numPixels</span><span class=p>)</span>
</span></span><span class=line><span class=cl>               <span class=o>:</span> <span class=s>&#34;r4&#34;</span><span class=p>,</span> <span class=s>&#34;r5&#34;</span><span class=p>,</span> <span class=s>&#34;r6&#34;</span>
</span></span><span class=line><span class=cl>               <span class=p>);</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=results>Results</h2><p>I’ve done color conversion on 640x512 image (well-known graffiti image) 100 times to get more precise time measures. Here is a chart with graphical illustrations of BGRA to GRAY conversion using different algorithms. I’ve added two 3-rd party implementations (One from OpenCV – cvCvtColor, and one from Boost::Gil – copy_and_convert_pixels) to see how are they optimized. Testing hardware - IPhone 3Gs,  iOS 4.2.</p><p><img src=bgra2grayconversion.png alt="BGRA to GRAY conversion" title="BGRA to GRAY conversion"></p><p>As we can see, NEON optimized assembler function works three times faster that C++ function with intrinsic and six times faster than pure C++ implementation.</p><h2 id=references>References</h2><ol><li><p>Many thanks for the <a href="http://hilbert-space.de/?p=22">Nils Pipenbrinck</a>. This article helps me a lot!</p></li><li><p><a href=http://blogs.arm.com/software-enablement/161-coding-for-neon-part-1-load-and-stores/>Coding for NEON - Part 1: Load and Stores</a></p></li></ol></div><div class=post__footer><span><a class=tag href=/tags/xcode/>xcode</a><a class=tag href=/tags/neon/>neon</a></span></div><div id=comment><h2>comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//cvtalks.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Eugene Khvedchenya
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-10687369-5","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>