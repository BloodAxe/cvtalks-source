<!doctype html><html dir=ltr lang=en data-theme class=html><head><title>Eugene Khvedchenya
|
OpenCV Tutorial Part 7</title><meta charset=utf-8><meta name=generator content="Hugo 0.98.0"><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><meta name=author content="Eugene Khvedchenya"><meta name=description content="A personal blog about Computer Vision, AI, Kaggle, Open-Source and research. You will never read this in books."><link rel=stylesheet href=/scss/main.min.b2e0cb07595e3519ab1193bb421914e06c0e26b0cc561fef23b3c6131d4d2ffa.css integrity="sha256-suDLB1leNRmrEZO7QhkU4GwOJrDMVh/vI7PGEx1NL/o=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/css/markupHighlight.min.31b0a1f317f55c529a460897848c97436bb138b19c399b37de70d463a8bf6ed5.css integrity="sha256-MbCh8xf1XFKaRgiXhIyXQ2uxOLGcOZs33nDUY6i/btU=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/fontawesome.min.7d272de35b410fb165377550cdf9c4d3a80fbbcc961e111914e4d5c0eaf5729f.css integrity="sha256-fSct41tBD7FlN3VQzfnE06gPu8yWHhEZFOTVwOr1cp8=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/solid.min.55d8333481b07a08e07cf6f37319753a2b47e99f4c395394c5747b48b495aa9b.css integrity="sha256-VdgzNIGwegjgfPbzcxl1OitH6Z9MOVOUxXR7SLSVqps=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/regular.min.a7448d02590b43449364b6b5922ed9af5410abb4de4238412a830316dedb850b.css integrity="sha256-p0SNAlkLQ0STZLa1ki7Zr1QQq7TeQjhBKoMDFt7bhQs=" crossorigin=anonymous type=text/css><link rel=stylesheet href=/fontawesome/css/brands.min.9ed75a5d670c953fe4df935937674b4646f92674367e9e66eb995bb04e821647.css integrity="sha256-ntdaXWcMlT/k35NZN2dLRkb5JnQ2fp5m65lbsE6CFkc=" crossorigin=anonymous type=text/css><link rel="shortcut icon" href=/favicon.ico type=image/x-icon><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=canonical href=https://computer-vision-talks.com/post/2012-10-22-opencv-tutorial-part-7/><script type=text/javascript src=/js/anatole-header.min.f9132794301a01ff16550ed66763482bd848f62243d278f5e550229a158bfd32.js integrity="sha256-+RMnlDAaAf8WVQ7WZ2NIK9hI9iJD0nj15VAimhWL/TI=" crossorigin=anonymous></script>
<script type=text/javascript src=/js/anatole-theme-switcher.min.560a26330d27ff44a44e83b53cd07a95d4230a65930d31c5c76a8d481e5b35bf.js integrity="sha256-VgomMw0n/0SkToO1PNB6ldQjCmWTDTHFx2qNSB5bNb8=" crossorigin=anonymous></script><meta name=twitter:card content="summary"><meta name=twitter:title content="OpenCV Tutorial Part 7"><meta name=twitter:description content="After a long delay i&rsquo;m happy to resume posting OpenCV tutorials in my blog. In Part 7 i will present you a new way of generation of icons for samples. Also i&rsquo;ll show how to use NEON and assembly language to speed-up cv::transform function twice! Also there are three new samples i have to say few words about each.
Interface improvements Default sample icons I think each sample has to have it&rsquo;s own unique icon image."><meta property="og:title" content="OpenCV Tutorial Part 7"><meta property="og:description" content="After a long delay i&rsquo;m happy to resume posting OpenCV tutorials in my blog. In Part 7 i will present you a new way of generation of icons for samples. Also i&rsquo;ll show how to use NEON and assembly language to speed-up cv::transform function twice! Also there are three new samples i have to say few words about each.
Interface improvements Default sample icons I think each sample has to have it&rsquo;s own unique icon image."><meta property="og:type" content="article"><meta property="og:url" content="https://computer-vision-talks.com/post/2012-10-22-opencv-tutorial-part-7/"><meta property="article:section" content="post"><meta property="article:published_time" content="2012-10-22T00:00:00+00:00"><meta property="article:modified_time" content="2012-10-22T00:00:00+00:00"><meta property="og:site_name" content="Computer Vision Talks"><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","articleSection":"post","name":"OpenCV Tutorial Part 7","headline":"OpenCV Tutorial Part 7","alternativeHeadline":"","description":"
      
        After a long delay i\u0026rsquo;m happy to resume posting OpenCV tutorials in my blog. In Part 7 i will present you a new way of generation of icons for samples. Also i\u0026rsquo;ll show how to use NEON and assembly language to speed-up cv::transform function twice! Also there are three new samples i have to say few words about each.\nInterface improvements Default sample icons I think each sample has to have it\u0026rsquo;s own unique icon image.


      


    ","inLanguage":"en-us","isFamilyFriendly":"true","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/computer-vision-talks.com\/post\/2012-10-22-opencv-tutorial-part-7\/"},"author":{"@type":"Person","name":"Eugene Khvedchenya"},"creator":{"@type":"Person","name":"Eugene Khvedchenya"},"accountablePerson":{"@type":"Person","name":"Eugene Khvedchenya"},"copyrightHolder":{"@type":"Person","name":"Eugene Khvedchenya"},"copyrightYear":"2012","dateCreated":"2012-10-22T00:00:00.00Z","datePublished":"2012-10-22T00:00:00.00Z","dateModified":"2012-10-22T00:00:00.00Z","publisher":{"@type":"Organization","name":"Eugene Khvedchenya","url":"https://computer-vision-talks.com/","logo":{"@type":"ImageObject","url":"https:\/\/computer-vision-talks.com\/favicon-32x32.png","width":"32","height":"32"}},"image":[],"url":"https:\/\/computer-vision-talks.com\/post\/2012-10-22-opencv-tutorial-part-7\/","wordCount":"994","genre":[],"keywords":["tutorials","opencv","xcode"]}</script></head><body class="body theme--light"><div class=wrapper><aside class=wrapper__sidebar><div class="sidebar
animated fadeInDown"><div class=sidebar__content><div class=sidebar__introduction><img class=sidebar__introduction-profileimage src=/images/4ECfkGJr_400x400.jpg alt="profile picture"><div class=sidebar__introduction-title><a href=/>Computer Vision Talks</a></div><div class=sidebar__introduction-description><p>A personal blog about Computer Vision, AI, Kaggle, Open-Source and research. You will never read this in books.</p></div></div><ul class=sidebar__list><li class=sidebar__list-item><a href=https://www.linkedin.com/in/cvtalks/ target=_blank rel=noopener aria-label=Linkedin title=Linkedin><i class="fab fa-linkedin fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://twitter.com/cvtalks target=_blank rel=noopener aria-label=Twitter title=Twitter><i class="fab fa-twitter fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=https://github.com/BloodAxe target=_blank rel=noopener aria-label=GitHub title=GitHub><i class="fab fa-github fa-2x" aria-hidden=true></i></a></li><li class=sidebar__list-item><a href=mailto:ekhvedchenya@computer-vision-talks.com target=_blank rel=noopener aria-label=E-Mail title=E-Mail><i class="fas fa-envelope fa-2x" aria-hidden=true></i></a></li></ul></div><footer class="footer footer__sidebar"><ul class=footer__list><li class=footer__item>&copy;
Eugene Khvedchenya
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-10687369-5","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></div></aside><main class=wrapper__main><header class=header><div class="animated fadeInDown"><a role=button class=navbar-burger data-target=navMenu aria-label=menu aria-expanded=false><span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span>
<span aria-hidden=true class=navbar-burger__line></span></a><nav class=nav><ul class=nav__list id=navMenu><li class=nav__list-item><a href=/ title>Home</a></li><li class=nav__list-item><a href=/post/ title>Posts</a></li><li class=nav__list-item><a href=/open-source title>Open-Source</a></li><li class=nav__list-item><a href=/challenges title>Wins</a></li><li class=nav__list-item><a href=/publications title>Publications</a></li></ul><ul class="nav__list nav__list--end"><li class=nav__list-item><div class=themeswitch><a title="Switch Theme"><i class="fas fa-adjust fa-fw" aria-hidden=true></i></a></div></li></ul></nav></div></header><div class="post
animated fadeInDown"><div class=post__content><h1>OpenCV Tutorial Part 7</h1><ul class=post__meta><li class=post__meta-item><em class="fas fa-calendar-day post__meta-icon"></em>
<span class=post__meta-text>Mon, Oct 22, 2012</span></li><li class=post__meta-item><em class="fas fa-stopwatch post__meta-icon"></em>
<span class=post__meta-text>5-minute read</span></li></ul><p>After a long delay i&rsquo;m happy to resume posting OpenCV tutorials in my blog. In Part 7 i will present you a new way of generation of icons for samples. Also i&rsquo;ll show how to use NEON and assembly language to speed-up cv::transform function twice! Also there are three new samples i have to say few words about each.</p><h2 id=interface-improvements>Interface improvements</h2><h3 id=default-sample-icons>Default sample icons</h3><p>I think each sample has to have it&rsquo;s own unique icon image. Unfortunately, i&rsquo;m not a cool graphic designer and i&rsquo;m lazy. And i found brillant solution how to create unique icon for almost any sample with minimal efforts. Our sample will generate it for us! It&rsquo;s so easy, right? We write a new sample that implements some cool effect. So it would be great if it&rsquo;s icon will inform user about it. To do this we take a default image we use for icons and pass it through our sample. Result image is the best visual demonstration we can ever imagine. Let&rsquo;s take a look on result of processing default icon with Cartoon Filter Sample: <strong>Default Image</strong>: ![][1]</p><h4 id=generated-cartoon-filter-icon><strong>Generated Cartoon Filter Icon</strong></h4><p>![][2]</p><p>Also, these icons are now used in the rest of UI. The final picture looks much more user-friendly:</p><p>![][3]</p><h3 id=in-case-you-looking-for-a-code>In case you looking for a code</h3><p>While working on this chapter i noticed that UI-realted code has a lot of duplicates connected with converting of std::string to NSString, loading UIImage objects from bundle. To remove such duplicates i added a special facade class which performs all conversion and implements sample icon generation as described above.</p><h4 id=samplefacade-interface><strong>SampleFacade interface</strong></h4><div class=highlight><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=k>@interface</span> <span class=nc>SampleFacade</span> : <span class=nc>NSObject</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=kt>id</span><span class=p>)</span> <span class=nf>initWithSample:</span><span class=p>(</span><span class=n>SampleBase</span><span class=o>*</span><span class=p>)</span> <span class=nv>sample</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>@property</span> <span class=p>(</span><span class=k>readonly</span><span class=p>)</span> <span class=n>SampleBase</span> <span class=o>*</span> <span class=n>sample</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span> <span class=nf>title</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span> <span class=nf>description</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>NSString</span> <span class=o>*</span><span class=p>)</span> <span class=nf>friendlyName</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span>   <span class=nf>smallIcon</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span>   <span class=nf>largeIcon</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=kt>bool</span><span class=p>)</span> <span class=nf>processFrame:</span><span class=p>(</span><span class=k>const</span> <span class=n>cv</span><span class=o>::</span><span class=n>Mat</span><span class=o>&amp;</span><span class=p>)</span> <span class=nv>inputFrame</span> <span class=nf>into:</span><span class=p>(</span><span class=n>cv</span><span class=o>::</span><span class=n>Mat</span><span class=o>&amp;</span><span class=p>)</span> <span class=nv>outputFrame</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span> <span class=nf>processFrame:</span><span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span> <span class=nv>source</span><span class=p>;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>@end</span>
</span></span></code></pre></div><h4 id=icons-generation>Icons generation</h4><p>When the data table is populated with a sample list it creates a cell for each sample. A cell contains a sample thumbnail image queried from [SampleFacade smallIcon].</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=n>UIImage</span><span class=o>*</span><span class=p>)</span>   <span class=nf>smallIcon</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=o>!</span><span class=n>m_smallIcon</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>sample</span><span class=o>-&gt;</span><span class=p>;</span><span class=n>hasIcon</span><span class=p>())</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>NSString</span> <span class=o>*</span> <span class=n>iconStr</span> <span class=o>=</span> <span class=p>[</span><span class=n>NSString</span> <span class=nl>stringWithStdString</span><span class=p>:</span><span class=nb>self</span><span class=p>.</span><span class=n>sample</span><span class=o>-&gt;</span><span class=p>;</span><span class=n>getSampleIcon</span><span class=p>()];</span>
</span></span><span class=line><span class=cl>            <span class=n>m_smallIcon</span> <span class=o>=</span> <span class=p>[[</span><span class=n>UIImage</span> <span class=nl>imageNamed</span><span class=p>:</span><span class=n>iconStr</span><span class=p>]</span> <span class=nl>thumbnailWithSize</span><span class=p>:</span><span class=mi>80</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=k>else</span>
</span></span><span class=line><span class=cl>        <span class=p>{</span>
</span></span><span class=line><span class=cl>            <span class=n>UIImage</span> <span class=o>*</span> <span class=n>srcImage</span> <span class=o>=</span> <span class=p>[</span><span class=n>UIImage</span> <span class=nl>imageNamed</span><span class=p>:</span><span class=s>@&#34;DefaultSampleIcon.png&#34;</span><span class=p>];</span>
</span></span><span class=line><span class=cl>            <span class=n>m_smallIcon</span> <span class=o>=</span> <span class=p>[</span><span class=nb>self</span> <span class=nl>processFrame</span><span class=p>:[</span><span class=n>srcImage</span> <span class=nl>thumbnailWithSize</span><span class=p>:</span><span class=mi>80</span><span class=p>]];</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=n>m_smallIcon</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>Obviously, this method of generating sample icon image cannot be applied to any sample. It&rsquo;s applicable only to samples that can process single image without any additional data input. For example, we can&rsquo;t use this method to generate icon for video tracking, because it will give us exactly the same picture. But for samples that does manipulate with pixels it&rsquo;s the ideal solution. ;</p><h3 id=more-friendly-ipad-interface>More friendly iPad interface</h3><p>When in landscape mode iPad&rsquo;s application interface shows list of samples and result of sample processing simultaneously. In the previous versions of the app, selecting new sample while previous was running had no effect. You had go back to sample information window and then click again &ldquo;run&rdquo; to start using new sample. Now it&rsquo;s fixed - you can switch to any sample any time you want. Watch this great demonstration video: Implementation was very trivial - when user taps &ldquo;Run on Video&rdquo; or &ldquo;Run on Image&rdquo; button we save new view controller in DetailViewController&rsquo;s private property:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>prepareForSegue:</span><span class=p>(</span><span class=n>UIStoryboardSegue</span> <span class=o>*</span><span class=p>)</span><span class=nv>segue</span> <span class=nf>sender:</span><span class=p>(</span><span class=kt>id</span><span class=p>)</span><span class=nv>sender</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>([[</span><span class=n>segue</span> <span class=n>identifier</span><span class=p>]</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;processVideo&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>VideoViewController</span> <span class=o>*</span> <span class=n>sampleController</span> <span class=o>=</span> <span class=p>[</span><span class=n>segue</span> <span class=n>destinationViewController</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>sampleController</span> <span class=nl>setSample</span><span class=p>:</span><span class=n>currentSample</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=p>.</span><span class=n>activeVideoController</span> <span class=o>=</span> <span class=n>sampleController</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=k>else</span> <span class=k>if</span> <span class=p>([[</span><span class=n>segue</span> <span class=n>identifier</span><span class=p>]</span> <span class=nl>isEqualToString</span><span class=p>:</span><span class=s>@&#34;processImage&#34;</span><span class=p>])</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=n>ImageViewController</span> <span class=o>*</span> <span class=n>sampleController</span> <span class=o>=</span> <span class=p>[</span><span class=n>segue</span> <span class=n>destinationViewController</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=p>[</span><span class=n>sampleController</span> <span class=nl>setSample</span><span class=p>:</span><span class=n>currentSample</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=p>.</span><span class=n>activeImageController</span> <span class=o>=</span> <span class=n>sampleController</span><span class=p>;</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>And modified configureView function now updates active image or video view if it&rsquo;s not null:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-objectivec data-lang=objectivec><span class=line><span class=cl><span class=p>-</span> <span class=p>(</span><span class=kt>void</span><span class=p>)</span><span class=nf>configureView</span>
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=c1>// Update the user interface for the detail item.
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>currentSample</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=p>.</span><span class=n>sampleDescriptionTextView</span><span class=p>.</span><span class=n>text</span> <span class=o>=</span> <span class=p>[</span><span class=n>currentSample</span> <span class=n>description</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=p>.</span><span class=n>title</span> <span class=o>=</span> <span class=p>[</span><span class=n>currentSample</span> <span class=n>title</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nb>self</span><span class=p>.</span><span class=n>sampleIconView</span><span class=p>.</span><span class=n>image</span> <span class=o>=</span> <span class=p>[</span><span class=n>currentSample</span> <span class=n>largeIcon</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>activeImageController</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>activeImageController</span> <span class=nl>setSample</span><span class=p>:</span><span class=n>currentSample</span><span class=p>];</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>        <span class=k>if</span> <span class=p>(</span><span class=nb>self</span><span class=p>.</span><span class=n>activeVideoController</span><span class=p>)</span>
</span></span><span class=line><span class=cl>            <span class=p>[</span><span class=nb>self</span><span class=p>.</span><span class=n>activeVideoController</span> <span class=nl>setSample</span><span class=p>:</span><span class=n>currentSample</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h2 id=performance-optimization>Performance optimization</h2><h3 id=optimizing-cvtransform-with-arm-neon>Optimizing cv::transform with ARM NEON</h3><p>Assembly language and architecture-specific code was always a subject of my special attention. After i got my first iPhone i started learning ARM Assembly and it&rsquo;s SIMD engine called NEON. As a result of my first attempts to write something useful i wrote [fast BGRA to Grayscale color conversion][4] function. It was a long time ago, but this function is still actual. NEON-accelerated BGRA to Grayscale conversion is being used in this project too. In this section i will show you how to improve performance of the cv::transform function. Linear transform is useful function. In our samples we use it for Sepia effect for example. Also it can perform BGRA to Gray conversion without reducing number of image channels, adjust contrast and swap channels. A brief theory if you forgot what this function does. A cv::transform function multiplies each image pixel on 4x4 matrix and puts resulting vector to destination image. Input pixel is vector of 4 elements (unsigned bytes), each element contains channel intensity in following order: B, G, R, A. The matrix is represented by a 4x4 floating point (single precision) array. Our goal is to rewrite multiplication of 4x4 matrix on 4-element Vector. First, a wrapping function:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-cpp data-lang=cpp><span class=line><span class=cl><span class=k>namespace</span> <span class=n>cv</span> 
</span></span><span class=line><span class=cl><span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kt>void</span> <span class=nf>neon_transform_bgra</span><span class=p>(</span><span class=k>const</span> <span class=n>cv</span><span class=o>::</span><span class=n>Mat</span><span class=o>&amp;</span> <span class=n>input</span><span class=p>,</span> <span class=n>cv</span><span class=o>::</span><span class=n>Mat</span><span class=o>&amp;</span> <span class=n>result</span><span class=p>,</span> <span class=k>const</span> <span class=n>cv</span><span class=o>::</span><span class=n>Mat_</span><span class=o>&amp;</span> <span class=n>m</span><span class=p>)</span>
</span></span><span class=line><span class=cl>  <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=n>assert</span><span class=p>(</span><span class=n>input</span><span class=p>.</span><span class=n>type</span><span class=p>()</span> <span class=o>==</span> <span class=n>CV_8UC4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>if</span> <span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>rows</span> <span class=o>!=</span> <span class=n>input</span><span class=p>.</span><span class=n>rows</span> <span class=o>||</span> <span class=n>result</span><span class=p>.</span><span class=n>cols</span> <span class=o>!=</span> <span class=n>input</span><span class=p>.</span><span class=n>cols</span> <span class=o>||</span> <span class=n>result</span><span class=p>.</span><span class=n>type</span><span class=p>()</span> <span class=o>!=</span> <span class=n>CV_8UC4</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>result</span><span class=p>.</span><span class=n>create</span><span class=p>(</span><span class=n>input</span><span class=p>.</span><span class=n>rows</span><span class=p>,</span> <span class=n>input</span><span class=p>.</span><span class=n>cols</span><span class=p>,</span> <span class=n>CV_8UC4</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=c1>//result = input.clone();
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//initSameSizeAlignedIfNecessary(m, result);
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=c1>//cv::Mat trans;
</span></span></span><span class=line><span class=cl><span class=c1></span>    <span class=c1>//cv::transpose(m, trans);
</span></span></span><span class=line><span class=cl><span class=c1></span>    
</span></span><span class=line><span class=cl>    <span class=kt>float</span> <span class=o>*</span> <span class=n>matrix</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=kt>float</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>m</span><span class=p>.</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>v</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    <span class=kt>int</span> <span class=n>out</span><span class=p>[</span><span class=mi>4</span><span class=p>];</span>
</span></span><span class=line><span class=cl>    
</span></span><span class=line><span class=cl>    <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>row</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>row</span> <span class=o>&lt;</span> <span class=n>input</span><span class=p>.</span><span class=n>rows</span><span class=p>;</span> <span class=n>row</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>    <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=n>cv</span><span class=o>::</span><span class=n>Vec4b</span> <span class=o>*</span> <span class=n>srcRow</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>cv</span><span class=o>::</span><span class=n>Vec4b</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>input</span><span class=p>.</span><span class=n>row</span><span class=p>(</span><span class=n>row</span><span class=p>).</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      <span class=n>cv</span><span class=o>::</span><span class=n>Vec4b</span> <span class=o>*</span> <span class=n>dstRow</span> <span class=o>=</span> <span class=k>reinterpret_cast</span><span class=o>&lt;</span><span class=n>cv</span><span class=o>::</span><span class=n>Vec4b</span><span class=o>*&gt;</span><span class=p>(</span><span class=n>result</span><span class=p>.</span><span class=n>row</span><span class=p>(</span><span class=n>row</span><span class=p>).</span><span class=n>data</span><span class=p>);</span>
</span></span><span class=line><span class=cl>      
</span></span><span class=line><span class=cl>      <span class=k>for</span> <span class=p>(</span><span class=kt>int</span> <span class=n>col</span> <span class=o>=</span> <span class=mi>0</span><span class=p>;</span> <span class=n>col</span> <span class=o>&lt;</span> <span class=n>input</span><span class=p>.</span><span class=n>cols</span><span class=p>;</span> <span class=n>col</span><span class=o>++</span><span class=p>)</span>
</span></span><span class=line><span class=cl>      <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=k>const</span> <span class=n>cv</span><span class=o>::</span><span class=n>Vec4b</span><span class=o>&amp;</span> <span class=n>src</span> <span class=o>=</span> <span class=n>srcRow</span><span class=p>[</span><span class=n>col</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=nl>cv</span><span class=p>:</span><span class=n>Vec4b</span><span class=o>&amp;</span> <span class=n>dst</span>        <span class=o>=</span> <span class=n>dstRow</span><span class=p>[</span><span class=n>col</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span>  <span class=n>src</span><span class=p>[</span><span class=mi>0</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span>  <span class=n>src</span><span class=p>[</span><span class=mi>1</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span>  <span class=n>src</span><span class=p>[</span><span class=mi>2</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        <span class=n>v</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span>  <span class=n>src</span><span class=p>[</span><span class=mi>3</span><span class=p>];</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>neon_asm_mat4_vec4_mul</span><span class=p>(</span><span class=n>matrix</span><span class=p>,</span> <span class=n>v</span><span class=p>,</span> <span class=n>out</span><span class=p>);</span>
</span></span><span class=line><span class=cl>        
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=p>[</span><span class=mi>0</span><span class=p>]</span> <span class=o>=</span> <span class=n>cv</span><span class=o>::</span><span class=n>saturate_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>&gt;</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>0</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=p>[</span><span class=mi>1</span><span class=p>]</span> <span class=o>=</span> <span class=n>cv</span><span class=o>::</span><span class=n>saturate_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>&gt;</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>1</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=p>[</span><span class=mi>2</span><span class=p>]</span> <span class=o>=</span> <span class=n>cv</span><span class=o>::</span><span class=n>saturate_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>&gt;</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>2</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>        <span class=n>dst</span><span class=p>[</span><span class=mi>3</span><span class=p>]</span> <span class=o>=</span> <span class=n>cv</span><span class=o>::</span><span class=n>saturate_cast</span><span class=o>&lt;</span><span class=kt>unsigned</span> <span class=kt>char</span><span class=o>&gt;</span><span class=p>(</span><span class=n>out</span><span class=p>[</span><span class=mi>3</span><span class=p>]);</span>
</span></span><span class=line><span class=cl>      <span class=p>}</span>
</span></span><span class=line><span class=cl>    <span class=p>}</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><p>[1]: IMG_0044.png (Mandrill (Original))
[2]: IMG_0045.jpg (Mandrill (Cartoon))
[3]: Screen-Shot-2012-08-19-at-9.05.33-PM-1024x813.png (OpenCV Tutorial Part 7 Sample Icons)
[4]: /articles/2011-02-08-a-very-fast-bgra-to-grayscale-conversion-on-iphone/ (A very fast BGRA to Grayscale conversion on Iphone)</p></div><div class=post__footer><span><a class=tag href=/tags/tutorials/>tutorials</a><a class=tag href=/tags/opencv/>opencv</a><a class=tag href=/tags/xcode/>xcode</a></span></div><div id=comment><h2>comments</h2><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//cvtalks.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></main></div><footer class="footer footer__base"><ul class=footer__list><li class=footer__item>&copy;
Eugene Khvedchenya
2022</li></ul></footer><script type=text/javascript src=/js/medium-zoom.min.9c062c557275acbaba71f0c7cd4024da3e3cc825d248bc4b2130811b0965330b.js integrity="sha256-nAYsVXJ1rLq6cfDHzUAk2j48yCXSSLxLITCBGwllMws=" crossorigin=anonymous></script>
<script type=application/javascript>var doNotTrack=!1;doNotTrack||(window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-10687369-5","auto"),ga("send","pageview"))</script><script async src=https://www.google-analytics.com/analytics.js></script></body></html>